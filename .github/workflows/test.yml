name: Test
on:
  workflow_dispatch:

jobs:
  calculate-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v7.1.4

      - name: Run script
        env:
          ZOTERO_ID: ${{ secrets.ZOTERO_ID }}
          ZOTERO_KEY: ${{ secrets.ZOTERO_KEY }}
          SENDER: ${{ secrets.SENDER }}
          RECEIVER: ${{ secrets.RECEIVER }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
          CUSTOM_CONFIG: ${{ vars.CUSTOM_CONFIG }}
        run: |
          export DEBUG=true
          printf "%b\n" "$CUSTOM_CONFIG" > config/custom.yaml
          echo "Use custom config: "
          cat config/custom.yaml

          echo "===== PROBE 1: curl arXiv RSS (headers) ====="
          set -x
          curl -I --max-time 20 --retry 3 --retry-delay 2 "https://rss.arxiv.org/atom/cs.CV" || true
          set +x

          echo "===== PROBE 1b: count <entry> (cs.CV/cs.AI/cs.LG) ====="
          for c in cs.CV cs.AI cs.LG; do
            echo "---- $c ----"
            curl -s --max-time 20 --retry 3 --retry-delay 2 "https://rss.arxiv.org/atom/$c" | grep -c "<entry" || true
            curl -s --max-time 20 --retry 3 --retry-delay 2 "https://rss.arxiv.org/atom/$c" | head -n 25 || true
          done

          echo "===== PROBE 2: feedparser parse RSS ====="
          uv run python - <<'PY'
          import feedparser, collections
          url = "https://rss.arxiv.org/atom/cs.CV"
          f = feedparser.parse(url)
          print("url:", url)
          print("feed.title:", getattr(f.feed, "title", None))
          print("feed.updated:", getattr(f.feed, "updated", None))
          entries = getattr(f, "entries", [])
          print("entries:", len(entries))
          print("bozo:", getattr(f, "bozo", None))
          print("bozo_exception:", getattr(f, "bozo_exception", None))
          types = collections.Counter(getattr(e, "arxiv_announce_type", "NONE") for e in entries)
          print("announce_type counts:", dict(types))
          for e in entries[:5]:
            print("sample:", getattr(e, "arxiv_announce_type", None), getattr(e, "id", None), getattr(e, "title", None))
          PY

          echo "===== RUN main ====="
          uv run src/zotero_arxiv_daily/main.py
